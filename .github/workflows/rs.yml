# Rust-only components (not part of Go server stack)
# For fuzzy-ax, qntx-core, and Go integration, see rsgo.yml

name: Rust

on:
  pull_request:
    branches: [main]
    paths:
      - 'web/src-tauri/**/*.rs'
      - 'web/src-tauri/Cargo.toml'
      - 'qntx-python/**/*.rs'
      - 'qntx-python/Cargo.toml'
      - '.github/workflows/rs.yml'
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'web/src-tauri/**/*.rs'
      - 'web/src-tauri/Cargo.toml'
      - 'qntx-python/**/*.rs'
      - 'qntx-python/Cargo.toml'
  workflow_dispatch:

# fuzzy-ax and qntx-core moved to rsgo.yml (requires Go integration)

jobs:
  qntx-python:
    name: Python Plugin
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: qntx
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Check formatting
        run: cd qntx-python && nix develop .. --command cargo fmt --check

      - name: Build via Nix (required for Python linking)
        run: nix build .#qntx-python --print-build-logs

      - name: Verify binary works
        run: ./result/bin/qntx-python-plugin --version

  # Legacy cargo-based checks (disabled - Python linking issues)
  # Kept for reference until Nix-based checks are stable
  # qntx-python-cargo:
  #   name: Python Plugin (Cargo)
  #   runs-on: ubuntu-latest
  #   container:
  #     image: ghcr.io/teranos/qntx:latest
  #     credentials:
  #       username: ${{ github.actor }}
  #       password: ${{ secrets.GITHUB_TOKEN }}
  #
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Configure git safe directory
  #       run: git config --global --add safe.directory /__w/QNTX/QNTX
  #
  #     - name: Cache Rust dependencies
  #       uses: swatinem/rust-cache@v2
  #       with:
  #         workspaces: qntx-python
  #
  #     - name: Find Python in container
  #       id: find-python
  #       run: |
  #         # Python3.13 is in the container but not in PATH
  #         # Find it in the Nix store
  #         PYTHON_PATH=$(find /nix/store -name "python3" -type f -path "*/python3-*/bin/python3" 2>/dev/null | head -1)
  #         if [ -z "$PYTHON_PATH" ]; then
  #           echo "ERROR: Could not find python3 in Nix store"
  #           exit 1
  #         fi
  #         echo "Found Python at: $PYTHON_PATH"
  #         $PYTHON_PATH --version
  #         echo "python_path=$PYTHON_PATH" >> $GITHUB_OUTPUT
  #
  #     - name: Check formatting
  #       run: cd qntx-python && cargo fmt --check
  #
  #     - name: Clippy
  #       run: cd qntx-python && cargo clippy --all-targets --all-features
  #       env:
  #         RUSTFLAGS: "-Dwarnings"
  #         PYO3_PYTHON: ${{ steps.find-python.outputs.python_path }}
  #
  #     - name: Test
  #       run: cd qntx-python && cargo test
  #       env:
  #         PYO3_PYTHON: ${{ steps.find-python.outputs.python_path }}
  #
  #     - name: Build release
  #       run: cd qntx-python && cargo build --release
  #       env:
  #         PYO3_PYTHON: ${{ steps.find-python.outputs.python_path }}
