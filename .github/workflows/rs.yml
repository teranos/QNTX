name: Rust

on:
  pull_request:
    branches: [main]
    paths:
      - '**/*.rs'
      - 'web/src-tauri/Cargo.toml'
      - 'crates/qntx/Cargo.toml'
      - 'crates/qntx-core/Cargo.toml'
      - 'crates/qntx-sqlite/Cargo.toml'
      - 'crates/qntx-wasm/Cargo.toml'
      - 'qntx-python/Cargo.toml'
      - '.github/workflows/rs.yml'
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - '**/*.rs'
      - 'web/src-tauri/Cargo.toml'
      - 'crates/qntx/Cargo.toml'
      - 'crates/qntx-wasm/Cargo.toml'
      - 'qntx-python/Cargo.toml'
  workflow_dispatch:

jobs:
  qntx-sqlite:
    name: SQLite Backend
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/teranos/qntx-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure git safe directory
        run: git config --global --add safe.directory /__w/QNTX/QNTX

      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --check --package qntx-core --package qntx-sqlite

      - name: Clippy
        run: cargo clippy --package qntx-core --package qntx-sqlite --all-targets --all-features
        env:
          RUSTFLAGS: "-Dwarnings"

      - name: Test Rust libraries
        run: cargo test --package qntx-core --package qntx-sqlite

      - name: Build release with FFI
        run: |
          cargo build --release --package qntx-sqlite --features ffi --lib
          ls -la target/release/libqntx_sqlite.* || echo "No library files found"

      - name: Test CGO integration
        run: |
          export LD_LIBRARY_PATH=$PWD/target/release:$LD_LIBRARY_PATH
          export DYLD_LIBRARY_PATH=$PWD/target/release:$DYLD_LIBRARY_PATH
          go test -tags rustsqlite -v ./ats/storage/sqlitecgo/...

  # TODO: Replace dtolnay/rust-toolchain with Nix derivation (nix build .#qntx-wasm)
  qntx-wasm:
    name: WASM Bridge
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
          components: rustfmt

      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Check formatting
        run: cargo fmt --check --package qntx-wasm

      - name: Build WASM module
        run: make rust-wasm

      - name: Test Go integration
        run: go test -v ./ats/wasm/...

  qntx-python:
    name: Python Plugin
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: qntx
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Check formatting
        run: nix develop ./qntx-python --command cargo fmt --check

      - name: Clippy (via Nix)
        run: nix flake check ./qntx-python --print-build-logs

      - name: Build and test via Nix (required for Python linking)
        run: nix build ./qntx-python#qntx-python-plugin --print-build-logs

      - name: Verify binary works
        run: ./result/bin/qntx-python-plugin --version

  # Legacy cargo-based checks (disabled - Python linking issues)
  # Kept for reference until Nix-based checks are stable
  # qntx-python-cargo:
  #   name: Python Plugin (Cargo)
  #   runs-on: ubuntu-latest
  #   container:
  #     image: ghcr.io/teranos/qntx:latest
  #     credentials:
  #       username: ${{ github.actor }}
  #       password: ${{ secrets.GITHUB_TOKEN }}
  #
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Configure git safe directory
  #       run: git config --global --add safe.directory /__w/QNTX/QNTX
  #
  #     - name: Cache Rust dependencies
  #       uses: swatinem/rust-cache@v2
  #       with:
  #         workspaces: qntx-python
  #
  #     - name: Find Python in container
  #       id: find-python
  #       run: |
  #         # Python3.13 is in the container but not in PATH
  #         # Find it in the Nix store
  #         PYTHON_PATH=$(find /nix/store -name "python3" -type f -path "*/python3-*/bin/python3" 2>/dev/null | head -1)
  #         if [ -z "$PYTHON_PATH" ]; then
  #           echo "ERROR: Could not find python3 in Nix store"
  #           exit 1
  #         fi
  #         echo "Found Python at: $PYTHON_PATH"
  #         $PYTHON_PATH --version
  #         echo "python_path=$PYTHON_PATH" >> $GITHUB_OUTPUT
  #
  #     - name: Check formatting
  #       run: cd qntx-python && cargo fmt --check
  #
  #     - name: Clippy
  #       run: cd qntx-python && cargo clippy --all-targets --all-features
  #       env:
  #         RUSTFLAGS: "-Dwarnings"
  #         PYO3_PYTHON: ${{ steps.find-python.outputs.python_path }}
  #
  #     - name: Test
  #       run: cd qntx-python && cargo test
  #       env:
  #         PYO3_PYTHON: ${{ steps.find-python.outputs.python_path }}
  #
  #     - name: Build release
  #       run: cd qntx-python && cargo build --release
  #       env:
  #         PYO3_PYTHON: ${{ steps.find-python.outputs.python_path }}
