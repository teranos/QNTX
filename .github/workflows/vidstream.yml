name: VidStream

on:
  pull_request:
    branches: [main]
    paths:
      - 'ats/vidstream/**/*.rs'
      - 'ats/vidstream/Cargo.toml'
      - 'ats/vidstream/**/*.go'
      - 'ats/vidstream/include/**'
      - '.github/workflows/vidstream.yml'
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'ats/vidstream/**/*.rs'
      - 'ats/vidstream/Cargo.toml'
      - 'ats/vidstream/**/*.go'
      - 'ats/vidstream/include/**'
  workflow_dispatch:

jobs:
  vidstream:
    name: VidStream (CGO + ONNX)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/teranos/qntx:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure git safe directory
        run: git config --global --add safe.directory /__w/QNTX/QNTX

      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: ats/vidstream

      - name: Check formatting
        run: cd ats/vidstream && cargo fmt --check

      - name: Clippy (without ONNX)
        run: cd ats/vidstream && cargo clippy --all-targets
        env:
          RUSTFLAGS: "-Dwarnings"

      - name: Clippy (with ONNX)
        run: cd ats/vidstream && cargo clippy --all-targets --features onnx
        env:
          RUSTFLAGS: "-Dwarnings"

      - name: Test (without ONNX - stub mode)
        run: cd ats/vidstream && cargo test --lib

      - name: Test (with ONNX - inference mode)
        run: cd ats/vidstream && cargo test --lib --features onnx

      - name: Build release (without ONNX)
        run: cd ats/vidstream && cargo build --release --lib

      - name: Build release (with ONNX)
        run: cd ats/vidstream && cargo build --release --lib --features onnx

      - name: Download test ONNX model
        run: |
          mkdir -p ats/vidstream/test-data
          cd ats/vidstream/test-data
          # Download YOLO11n (nano) - smallest YOLO model (~10MB)
          curl -L -o yolo11n.onnx https://github.com/ultralytics/assets/releases/download/v8.3.0/yolo11n.onnx
          ls -lh yolo11n.onnx

      - name: Test CGO integration
        run: |
          cd ats/vidstream && cargo build --release --lib
          export LD_LIBRARY_PATH=$PWD/target/release:$LD_LIBRARY_PATH
          export DYLD_LIBRARY_PATH=$PWD/target/release:$DYLD_LIBRARY_PATH
          export QNTX_VIDSTREAM_TEST_MODEL=$PWD/test-data/yolo11n.onnx
          cd vidstream && CGO_ENABLED=1 go test -tags rustvideo -v
