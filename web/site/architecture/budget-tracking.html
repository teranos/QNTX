<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QNTX - budget-tracking</title>
  <link rel="icon" type="image/jpeg" href="../qntx.jpg">
  <link rel="stylesheet" href="../css/core.css">
  <link rel="stylesheet" href="../css/docs.css">
</head>
<body>
<nav class="doc-nav">
  <a href="../index.html">
    <img src="../qntx.jpg" alt="QNTX" class="site-logo">Documentation Home
  </a>
</nav>
<h1>Budget Tracking Architecture</h1>
<h2>Overview</h2>
<p>QNTX has a two-component budget tracking system where <code>ai/tracker</code> records individual API calls and feeds data to <code>pulse/budget</code> for centralized budget management and enforcement.</p>
<h2>Component Responsibilities</h2>
<h3>ai/tracker</h3>
<p><strong>Purpose</strong>: Records every API call for auditing and cost tracking</p>
<ul>
<li>Captures API call metadata (model, tokens, cost)</li>
<li>Stores detailed usage history</li>
<li>Provides usage analytics and reporting</li>
<li>Acts as the data collection layer</li>
</ul>
<h3>pulse/budget</h3>
<p><strong>Purpose</strong>: Centralized budget management and enforcement</p>
<ul>
<li>Enforces daily/weekly/monthly spending limits</li>
<li>Makes go/no-go decisions for new operations</li>
<li>Tracks aggregate spending across all sources</li>
<li>Implements rate limiting based on budget constraints</li>
<li>Can pause or fail jobs when budget exceeded (configurable)</li>
</ul>
<h2>Data Flow</h2>
<pre><code>API Call → ai/tracker (records) → pulse/budget (aggregates) → Decision
                ↓                           ↓
          Usage History              Budget Enforcement
</code></pre>
<ol>
<li><strong>API Call Made</strong>: Any component making an API call uses ai/tracker</li>
<li><strong>Usage Recorded</strong>: ai/tracker logs the call details and cost</li>
<li><strong>Budget Updated</strong>: ai/tracker feeds cost data to pulse/budget</li>
<li><strong>Enforcement</strong>: pulse/budget checks if future calls are within limits</li>
<li><strong>Decision</strong>: Allow/deny/pause based on budget status</li>
</ol>
<h2>Database Schema</h2>
<h3>pulse_budget table</h3>
<p>Tracks aggregate spending and limits:</p>
<ul>
<li><code>spend_usd</code> - Current spend amount</li>
<li><code>daily_budget</code> - Daily limit</li>
<li><code>weekly_budget</code> - Weekly limit</li>
<li><code>monthly_budget</code> - Monthly limit</li>
<li><code>last_reset</code> - When counters were last reset</li>
</ul>
<h3>AI usage tracking</h3>
<p>Detailed per-call tracking (exact schema varies by implementation)</p>
<h2>Configuration</h2>
<p>Budget settings in <code>am.toml</code>:</p>
<pre><code class="language-toml">[pulse]
daily_budget_usd = 10.0
weekly_budget_usd = 50.0
monthly_budget_usd = 150.0
pause_on_budget_exceeded = true  # or false to fail jobs
</code></pre>
<h2>Integration Points</h2>
<ul>
<li><strong>Async Jobs</strong>: Check budget before expensive operations</li>
<li><strong>API Clients</strong>: Use ai/tracker for all external API calls</li>
<li><strong>Pulse Ticker</strong>: Resets daily/weekly/monthly counters</li>
<li><strong>Web UI</strong>: Displays budget status and usage history</li>
</ul>
<h2>Monitoring Budget Status</h2>
<pre><code class="language-bash"># Check current budget status
qntx am get pulse.daily_budget_usd    # See limit
qntx pulse status                      # See current usage

# View in web UI
# Navigate to Pulse panel → Budget tab
</code></pre>
<h2>Common Scenarios</h2>
<p><strong>Budget Exceeded</strong>: Jobs will pause (if <code>pause_on_budget_exceeded = true</code>) or fail. Check logs for <code>꩜ Budget exceeded</code> messages.</p>
<p><strong>Reset Timing</strong>: Counters reset at midnight UTC for daily, Sunday midnight for weekly, first of month for monthly.</p>
<footer class="site-footer">
  <p class="provenance">Generated by sitegen.nix at commit <a href="https://github.com/teranos/QNTX/commit/0e7ca38dd1dcce5d67e9797b91950b21353f137a-dirty">0e7ca38-dirty</a></p>
</footer>
</body>
</html>
