<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QNTX - two-phase-jobs</title>
  <link rel="icon" type="image/jpeg" href="../qntx.jpg">
  <link rel="stylesheet" href="../css/core.css">
  <link rel="stylesheet" href="../css/docs.css">
</head>
<body>
<nav class="doc-nav">
  <a href="../index.html">
    <img src="../qntx.jpg" alt="QNTX" class="site-logo">Documentation Home
  </a>
</nav>
<h1>Two-Phase Job Pattern</h1>
<h2>Overview</h2>
<p>Pulse supports a two-phase job pattern for complex workflows that need to spawn child tasks and aggregate results.</p>
<h2>Job Phases</h2>
<h3>Phase 1: Ingest</h3>
<ul>
<li>Process initial data</li>
<li>Create sub-entities</li>
<li>Enqueue child tasks</li>
<li>Track child job IDs</li>
</ul>
<h3>Phase 2: Aggregate</h3>
<ul>
<li>Wait for child tasks to complete</li>
<li>Aggregate results</li>
<li>Perform final processing</li>
<li>Update parent entity</li>
</ul>
<h2>Implementation</h2>
<p>Jobs track their phase using JobMetadata:</p>
<pre><code class="language-go">type JobMetadata struct {
    Phase string `json:"phase,omitempty"` // "ingest" or "aggregate"
    // Other metadata fields as needed
}
</code></pre>
<h3>Phase Detection</h3>
<pre><code class="language-go">if job.Metadata != nil &amp;&amp; job.Metadata.Phase == "aggregate" {
    // Aggregate phase logic
} else {
    // Ingest phase logic (default)
}
</code></pre>
<h3>Parent-Child Relationships</h3>
<p>Jobs maintain parent-child relationships through:</p>
<ul>
<li><code>parent_job_id</code> field in the async_ix_jobs table</li>
<li>Tracking child job IDs in parent's payload</li>
<li>Status propagation from children to parent</li>
</ul>
<h2>Example Workflow</h2>
<pre><code>1. Parent job starts (ingest phase)
   ↓
2. Creates N child jobs
   ↓
3. Parent pauses/waits
   ↓
4. Children complete
   ↓
5. Parent resumes (aggregate phase)
   ↓
6. Parent aggregates results
   ↓
7. Parent completes
</code></pre>
<h2>Use Cases</h2>
<ul>
<li><strong>Batch Processing</strong>: Process list of items, aggregate results</li>
<li><strong>Hierarchical Data</strong>: Process parent entity, then children</li>
<li><strong>Fan-out/Fan-in</strong>: Distribute work, collect results</li>
<li><strong>Multi-stage Pipelines</strong>: Sequential processing stages</li>
</ul>
<h2>Configuration</h2>
<p>No special configuration required. The pattern is implemented through job handler logic and JobMetadata.</p>
<h2>Best Practices</h2>
<ol>
<li><strong>Always set phase explicitly</strong> in JobMetadata when using this pattern</li>
<li><strong>Track child job IDs</strong> in parent payload for monitoring</li>
<li><strong>Handle partial failures</strong> - some children may fail</li>
<li><strong>Set reasonable timeouts</strong> for aggregate phase</li>
<li><strong>Use retry logic</strong> appropriately for each phase</li>
</ol>
<h2>Related Documentation</h2>
<ul>
<li><a href="pulse-async-ix.html">Pulse Async Architecture</a></li>
<li><a href="../development/grace.html">Opening (✿) and Closing (❀)</a> - Handles job recovery</li>
<li><a href="../types/async.html">Job Type Definitions</a></li>
</ul>
<footer class="site-footer">
  <p class="provenance">Generated by sitegen.nix at commit <a href="https://github.com/teranos/QNTX/commit/0e7ca38dd1dcce5d67e9797b91950b21353f137a-dirty">0e7ca38-dirty</a></p>
</footer>
</body>
</html>
