<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QNTX - config-system</title>
  <link rel="icon" type="image/jpeg" href="../qntx.jpg">
  <link rel="stylesheet" href="../css/core.css">
  <link rel="stylesheet" href="../css/docs.css">
</head>
<body>
<nav class="doc-nav">
  <a href="../index.html">
    <img src="../qntx.jpg" alt="QNTX" class="site-logo">Documentation Home
  </a>
</nav>
<h1>Configuration System Architecture</h1>
<h2>Overview</h2>
<p>QNTX uses a layered configuration system with five sources, merged with clear precedence rules. This design allows system-wide defaults, user preferences, team settings, and environment overrides to coexist cleanly. For the UI implementation of this system, see <a href="../development/config-panel.html">Config Panel</a>. For the REST API, see <a href="../api/configuration.html">Configuration API</a>.</p>
<h2>Configuration Sources</h2>
<p>Configuration is loaded from multiple sources in this order (lowest to highest precedence):</p>
<pre><code>1. System      /etc/qntx/config.toml               # System-wide defaults
2. User        ~/.qntx/config.toml                 # User manual configuration
3. User UI     ~/.qntx/config_from_ui.toml         # UI-managed configuration
4. Project     ./config.toml                       # Project/team configuration
5. Environment QNTX_* environment variables        # Runtime overrides
</code></pre>
<h3>Source Precedence</h3>
<p>Each layer overrides values from lower layers. For example:</p>
<ul>
<li>System sets <code>daily_budget_usd = 5.0</code></li>
<li>User manually sets <code>daily_budget_usd = 10.0</code> in <code>~/.qntx/config.toml</code></li>
<li>Project sets <code>daily_budget_usd = 20.0</code> in project <code>config.toml</code></li>
<li><strong>Result</strong>: <code>20.0</code> (project wins)</li>
</ul>
<h2>File Responsibilities</h2>
<h3>System Config (<code>/etc/qntx/config.toml</code>)</h3>
<ul>
<li>Installed by package manager or system administrator</li>
<li>Contains sensible defaults for all users on the system</li>
<li>Rarely modified by end users</li>
<li>Example: Default API endpoints, system-wide rate limits</li>
</ul>
<h3>User Config (<code>~/.qntx/config.toml</code>)</h3>
<ul>
<li>User's manually edited configuration</li>
<li>Preserves comments and formatting</li>
<li>For settings the user wants to persist across projects</li>
<li>Example: Personal API keys, preferred models</li>
</ul>
<h3>UI Config (<code>~/.qntx/config_from_ui.toml</code>)</h3>
<ul>
<li><strong>Auto-generated</strong> - created and managed by the web UI</li>
<li>Comments are not preserved (regenerated on each UI change)</li>
<li>Git-safe: Never accidentally committed to project repos</li>
<li>Example: Ollama vs OpenRouter toggle, model selection</li>
</ul>
<h3>Project Config (<code>./config.toml</code>)</h3>
<ul>
<li>Project-specific configuration</li>
<li>Checked into git for team sharing</li>
<li>Highest precedence among files (only environment beats it)</li>
<li>Example: Team API keys, project-specific models</li>
</ul>
<h3>Environment Variables</h3>
<ul>
<li>Highest precedence - overrides all files</li>
<li>Format: <code>QNTX_SECTION_KEY=value</code></li>
<li>Example: <code>QNTX_PULSE_DAILY_BUDGET_USD=50.0</code></li>
</ul>
<h2>Config Update Strategy</h2>
<h3>UI Updates (Web Interface)</h3>
<p>All UI changes write to <code>~/.qntx/config_from_ui.toml</code>:</p>
<pre><code class="language-go">// Example: Toggle Ollama
config.UpdateLocalInferenceEnabled(true)
</code></pre>
<p><strong>Implementation:</strong></p>
<ol>
<li>Load existing UI config (or create if missing)</li>
<li>Update specific field</li>
<li>Marshal entire config struct to TOML</li>
<li>Create backup (.back1, .back2, .back3 rotation)</li>
<li>Write to <code>~/.qntx/config_from_ui.toml</code></li>
</ol>
<p><strong>Benefits:</strong></p>
<ul>
<li>Type-safe updates (no regex)</li>
<li>Atomic file writes</li>
<li>Backup system for rollback</li>
<li>Never touches project config</li>
</ul>
<h3>Manual Updates</h3>
<p>Users edit <code>~/.qntx/config.toml</code> directly:</p>
<ul>
<li>Comments and formatting preserved</li>
<li>Full control over structure</li>
<li>Precedence: Higher than UI config but lower than project config</li>
</ul>
<h2>Source Tracking (Introspection)</h2>
<h3>Why Introspection?</h3>
<p><strong>SRE approach to configuration.</strong> Multi-source config creates observability problems. When something doesn't work, you need to know <em>why</em>.</p>
<p><strong>Debugging</strong>: "Why isn't my config working?" User toggles Ollama in UI, nothing happens. Introspection shows project config is overriding user_ui. Now they know what to fix.</p>
<p><strong>Trust/transparency</strong>: Without visibility, UI changes feel broken. Introspection proves changes took effect (or shows what's overriding them).</p>
<p><strong>Security audit</strong>: See if environment vars are leaking into places they shouldn't. Know what's coming from where.</p>
<h3>How It Works</h3>
<p>The introspection endpoint (<code>/api/config</code>) shows where each value comes from:</p>
<pre><code class="language-json">{
  "local_inference": {
    "enabled": {
      "value": true,
      "source": "user_ui",        // From ~/.qntx/config_from_ui.toml
      "type": "bool"
    },
    "model": {
      "value": "llama3.2:3b",
      "source": "project",         // From ./config.toml
      "type": "string"
    }
  }
}
</code></pre>
<p><strong>Source values:</strong></p>
<ul>
<li><code>system</code> - From /etc/qntx/config.toml</li>
<li><code>user</code> - From ~/.qntx/config.toml</li>
<li><code>user_ui</code> - From ~/.qntx/config_from_ui.toml</li>
<li><code>project</code> - From ./config.toml</li>
<li><code>environment</code> - From QNTX_* env vars</li>
</ul>
<h2>Implementation Details</h2>
<h3>Config Loading</h3>
<pre><code class="language-go">// Internal/config/config.go
func LoadConfig() (*Config, error) {
    // 1. Parse each source separately
    systemCfg := parseConfig("/etc/qntx/config.toml")
    userCfg := parseConfig("~/.qntx/config.toml")
    uiCfg := parseConfig("~/.qntx/config_from_ui.toml")
    projectCfg := parseConfig("./config.toml")

    // 2. Build source map (track where each value comes from)
    sources := buildSourceMap(systemCfg, userCfg, uiCfg, projectCfg)

    // 3. Merge with precedence
    merged := mergeConfigs(systemCfg, userCfg, uiCfg, projectCfg)

    // 4. Apply environment overrides
    applyEnvOverrides(merged)

    return merged, nil
}
</code></pre>
<h3>Config Persistence</h3>
<pre><code class="language-go">// Internal/config/persist.go
func UpdateLocalInferenceEnabled(enabled bool) error {
    // Get UI config path
    path := GetUIConfigPath()  // ~/.qntx/config_from_ui.toml

    // Load or initialize
    config, err := loadOrInitializeUIConfig()
    if err != nil {
        return err
    }

    // Update field (type-safe)
    config.LocalInference.Enabled = enabled

    // Save with backups
    return saveUIConfig(path, config)
}
</code></pre>
<h2>Migration and Compatibility</h2>
<h3>Existing Configs</h3>
<p>No migration required:</p>
<ul>
<li>Existing <code>config.toml</code> files work unchanged</li>
<li>First UI update creates <code>~/.qntx/config_from_ui.toml</code></li>
<li>Precedence ensures no breaking changes</li>
</ul>
<h3>Comment Preservation</h3>
<ul>
<li><strong>Manual config</strong> (<code>~/.qntx/config.toml</code>): Comments preserved</li>
<li><strong>UI config</strong> (<code>~/.qntx/config_from_ui.toml</code>): Comments not preserved (auto-generated)</li>
<li><strong>Recommendation</strong>: Put important comments in manual config, not UI config</li>
</ul>
<h2>Design Rationale</h2>
<h3>Why Separate UI Config?</h3>
<p><strong>Problem:</strong> Original design wrote UI changes to project <code>config.toml</code>, risking accidental git commits of user preferences.</p>
<p><strong>Solution:</strong> Separate <code>config_from_ui.toml</code> ensures:</p>
<ol>
<li>UI changes never touch project config</li>
<li>Project config remains team-shared</li>
<li>User preferences stay local</li>
</ol>
<h3>Why TOML Marshaling vs Regex?</h3>
<p><strong>Original approach:</strong> Regex pattern matching to preserve comments:</p>
<pre><code class="language-go">re := regexp.MustCompile(`(?sm)(\[local_inference\][^\[]*?^enabled\s*=\s*)(true|false)(.*)`)
updated := re.ReplaceAllString(content, fmt.Sprintf("${1}%s${3}", newValue))
</code></pre>
<p><strong>Problems:</strong></p>
<ul>
<li>Fragile (breaks with formatting changes)</li>
<li>Hard to maintain</li>
<li>No type safety</li>
<li>Error-prone</li>
</ul>
<p><strong>Current approach:</strong> Proper TOML marshaling:</p>
<pre><code class="language-go">config.LocalInference.Enabled = enabled
toml.Marshal(config)
</code></pre>
<p><strong>Benefits:</strong></p>
<ul>
<li>Type-safe</li>
<li>Simple, maintainable</li>
<li>Validates TOML structure</li>
<li>Self-documenting</li>
</ul>
<p><strong>Tradeoff:</strong> Comments in UI config are lost (acceptable for auto-generated file).</p>
<h2>Related Documentation</h2>
<ul>
<li><strong>UI Design</strong>: <a href="../development/config-panel.html">Config Panel</a> - Config panel UI/UX specification and future vision</li>
<li><strong>Glossary</strong>: <a href="../GLOSSARY.md#configuration">Configuration Terms</a> - Symbol and command reference</li>
<li><strong>User Guide</strong>: How to configure QNTX (TBD)</li>
</ul>
<h2>Future Enhancements</h2>
<p>Potential additions (not currently in scope):</p>
<ol>
<li><strong>Config validation</strong>: Warn about invalid values before save</li>
<li><strong>Reset to defaults</strong>: UI button to clear user_ui config</li>
<li><strong>Export merged config</strong>: Download effective configuration</li>
<li><strong>Config diff view</strong>: Show what's different from defaults</li>
<li><strong>Multi-environment support</strong>: Dev/staging/prod profiles</li>
</ol>
<footer class="site-footer">
  <p class="provenance">Generated by sitegen.nix at commit <a href="https://github.com/teranos/QNTX/commit/0e7ca38dd1dcce5d67e9797b91950b21353f137a-dirty">0e7ca38-dirty</a></p>
</footer>
</body>
</html>
