<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QNTX - ADR-002-plugin-configuration</title>
  <link rel="icon" type="image/jpeg" href="../qntx.jpg">
  <link rel="stylesheet" href="../css/core.css">
  <link rel="stylesheet" href="../css/docs.css">
</head>
<body>
<nav class="doc-nav">
  <a href="../index.html">
    <img src="../qntx.jpg" alt="QNTX" class="site-logo">Documentation Home
  </a>
</nav>
<h1>ADR-002: Plugin Configuration Management</h1>
<p><strong>Status:</strong> Accepted (Updated 2026-01-04)
<strong>Date:</strong> 2026-01-04
<strong>Deciders:</strong> QNTX Core Team</p>
<h2>Context</h2>
<p>Domain plugins need configuration for:</p>
<ol>
<li><strong>Discovery</strong>: Where to find plugin binaries</li>
<li><strong>Selection</strong>: Which plugins to load (explicit opt-in)</li>
<li><strong>Plugin-specific settings</strong>: API keys, workspace paths, feature flags</li>
</ol>
<p>Requirements:</p>
<ul>
<li>Works with QNTX's "minimal core" philosophy (no plugins by default)</li>
<li>Simple, centralized configuration in <code>am.toml</code></li>
<li>Supports plugin discovery from filesystem</li>
<li>Plugin-specific config without bloating main config</li>
</ul>
<h2>Decision</h2>
<h3>Configuration Model: Whitelist + Discovery Paths</h3>
<p>Plugins are configured via a single <code>[plugin]</code> section in <code>am.toml</code>:</p>
<pre><code class="language-toml">[plugin]
enabled = ["code"]                      # Whitelist of plugins to load
paths = ["~/.qntx/plugins", "./plugins"] # Where to search for binaries
</code></pre>
<p><strong>Key principles:</strong></p>
<ul>
<li><strong>No plugins by default</strong>: Empty <code>enabled</code> list means minimal core mode</li>
<li><strong>Explicit opt-in</strong>: Users must add plugin name to <code>enabled</code> list</li>
<li><strong>Automatic discovery</strong>: QNTX searches configured paths for binaries</li>
<li><strong>Fail-soft</strong>: Missing plugins log warning, don't prevent startup</li>
</ul>
<h3>Plugin Discovery</h3>
<p>QNTX searches for plugin binaries using common naming conventions:</p>
<pre><code>~/.qntx/plugins/qntx-code-plugin    # Preferred naming
~/.qntx/plugins/qntx-code           # Alternative
~/.qntx/plugins/code                # Fallback
./plugins/qntx-code-plugin          # Project-level plugins
</code></pre>
<p>Discovery algorithm:</p>
<ol>
<li>For each plugin in <code>enabled</code> list (e.g., <code>"code"</code>)</li>
<li>Search each path in <code>paths</code> for binaries matching:
<ul>
<li><code>qntx-{name}-plugin</code></li>
<li><code>qntx-{name}</code></li>
<li><code>{name}</code></li>
</ul>
</li>
<li>Verify binary is executable</li>
<li>Load first match via gRPC</li>
</ol>
<h3>Plugin-Specific Configuration</h3>
<p>Plugin-specific settings remain in <code>am.toml</code> under domain namespace:</p>
<pre><code class="language-toml"># Core QNTX configuration
[database]
path = "qntx.db"

[server]
port = 877

[pulse]
workers = 4

# Plugin configuration
[plugin]
enabled = ["code"]
paths = ["~/.qntx/plugins"]

# Code plugin specific settings
[code.gopls]
enabled = true
workspace_root = "."

[code.github]
# API token preferably from environment: QNTX_CODE_GITHUB_TOKEN
</code></pre>
<h3>Configuration Access in Plugins</h3>
<p>Plugins receive <code>Config</code> interface via <code>ServiceRegistry</code>:</p>
<pre><code class="language-go">func (p *Plugin) Initialize(ctx context.Context, services ServiceRegistry) error {
    config := services.Config("code")  // Gets [code.*] section from am.toml

    // Provide sensible defaults
    workspace := config.GetString("gopls.workspace_root")
    if workspace == "" {
        workspace = "."  // Default to current directory
    }

    // Optional features degrade gracefully
    apiToken := config.GetString("github.api_token")
    if apiToken == "" {
        p.logger.Warn("GitHub API token not configured, PR integration disabled")
        // Plugin still initializes, feature disabled
    }
}
</code></pre>
<h3>Environment Variable Overrides</h3>
<p>Sensitive values should prefer environment variables:</p>
<pre><code class="language-bash"># .env or shell
export QNTX_CODE_GITHUB_TOKEN="ghp_..."
export QNTX_DATABASE_PATH="custom.db"
</code></pre>
<p>Environment variables follow pattern: <code>QNTX_{DOMAIN}_{KEY}</code></p>
<p>Configuration precedence:</p>
<ol>
<li>Environment variables (highest priority)</li>
<li><code>am.toml</code> values</li>
<li>Plugin defaults (lowest priority)</li>
</ol>
<h2>Configuration Examples</h2>
<h3>Minimal Core (No Plugins)</h3>
<pre><code class="language-toml"># am.toml - minimal QNTX
[database]
path = "qntx.db"

[server]
port = 877

# No [plugin] section = no plugins loaded
</code></pre>
<p>QNTX runs with only:</p>
<ul>
<li>ATS (attestation system)</li>
<li>Database (⊔)</li>
<li>Pulse (꩜ async jobs)</li>
<li>Server (graph visualization)</li>
</ul>
<h3>Code Plugin Enabled</h3>
<pre><code class="language-toml">[plugin]
enabled = ["code"]
paths = ["~/.qntx/plugins", "./plugins"]

[code.gopls]
enabled = true
workspace_root = "."
</code></pre>
<h3>Multiple Plugins</h3>
<pre><code class="language-toml">[plugin]
enabled = ["code", "finance", "biotech"]
paths = ["~/.qntx/plugins"]

[code.gopls]
workspace_root = "/workspace/main-repo"

[finance]
api_key = "${FINANCE_API_KEY}"

[biotech.ncbi]
api_key = "${NCBI_API_KEY}"
email = "researcher@example.com"
</code></pre>
<h2>Consequences</h2>
<h3>Positive</h3>
<p>✅ <strong>Minimal by default</strong>: No plugins loaded unless explicitly configured
✅ <strong>Simple discovery</strong>: Just drop binary in <code>~/.qntx/plugins/</code> and add to enabled list
✅ <strong>Centralized config</strong>: All configuration in one <code>am.toml</code> file
✅ <strong>Flexible paths</strong>: Support both user-level (<code>~/.qntx/plugins</code>) and project-level (<code>./plugins</code>)
✅ <strong>Optional</strong>: QNTX works without any plugins (minimal core mode)
✅ <strong>Standard naming</strong>: Common conventions make plugin binaries discoverable</p>
<h3>Negative</h3>
<p>⚠️ <strong>Manual installation</strong>: Users must download/build plugin binaries
⚠️ <strong>Path management</strong>: Users must ensure binaries are in configured paths
⚠️ <strong>No version management</strong>: No automatic plugin updates (manual for now)</p>
<h3>Neutral</h3>
<ul>
<li>Plugin configuration lives in same file as core config (domain-namespaced)</li>
<li>Discovery is filesystem-based (simple but requires manual binary management)</li>
<li>Future: Could add plugin registry/marketplace for automatic installation</li>
</ul>
<h2>Implementation</h2>
<h3>Configuration Schema</h3>
<pre><code class="language-go">// am/am.go
type Config struct {
    Plugin PluginConfig `mapstructure:"plugin"`
    // ... other config sections
}

type PluginConfig struct {
    Enabled []string `mapstructure:"enabled"` // Whitelist of plugins
    Paths   []string `mapstructure:"paths"`   // Search paths
}
</code></pre>
<h3>Plugin Discovery</h3>
<pre><code class="language-go">// plugin/grpc/loader.go
func LoadPluginsFromConfig(ctx context.Context, cfg *am.Config, logger *zap.SugaredLogger) (*PluginManager, error) {
    manager := NewPluginManager(logger)

    if len(cfg.Plugin.Enabled) == 0 {
        logger.Infow("No plugins enabled - QNTX running in minimal core mode")
        return manager, nil
    }

    // Discover plugins from configured paths
    for _, pluginName := range cfg.Plugin.Enabled {
        pluginConfig, err := discoverPlugin(pluginName, cfg.Plugin.Paths, logger)
        if err != nil {
            logger.Warnw("Failed to discover plugin", "plugin", pluginName, "error", err)
            continue
        }

        // Load plugin via gRPC
        if err := manager.LoadPlugins(ctx, []PluginConfig{pluginConfig}); err != nil {
            return nil, err
        }
    }

    return manager, nil
}
</code></pre>
<h3>Binary Naming Conventions</h3>
<p>Plugins should use these naming conventions for discoverability:</p>
<table><thead><tr><th>Pattern</th><th>Example</th><th>Priority</th></tr></thead><tbody>
<tr><td><code>qntx-{domain}-plugin</code></td><td><code>qntx-code-plugin</code></td><td>Preferred</td></tr>
<tr><td><code>qntx-{domain}</code></td><td><code>qntx-code</code></td><td>Alternative</td></tr>
<tr><td><code>{domain}</code></td><td><code>code</code></td><td>Fallback</td></tr>
</tbody></table>
<p>All binaries must be:</p>
<ul>
<li>Executable (<code>chmod +x</code>)</li>
<li>Located in one of the configured search paths</li>
<li>Implement gRPC plugin protocol</li>
</ul>
<h2>Migration Path</h2>
<h3>From Phase 2 (Built-in Plugins)</h3>
<p>Before Phase 3:</p>
<pre><code class="language-go">// main.go - hardcoded
codePlugin := qntxcode.NewPlugin()
registry.Register(codePlugin)
</code></pre>
<p>After Phase 3:</p>
<pre><code class="language-toml"># am.toml
[plugin]
enabled = ["code"]
paths = ["~/.qntx/plugins"]
</code></pre>
<pre><code class="language-go">// main.go - discovery
manager, _ := grpc.LoadPluginsFromConfig(ctx, cfg, logger)
for _, plugin := range manager.GetAllPlugins() {
    registry.Register(plugin)
}
</code></pre>
<h3>Future: Plugin Marketplace (Phase 5+)</h3>
<p>Potential future enhancements:</p>
<pre><code class="language-bash">$ qntx plugin install code
Downloading qntx-code-plugin v0.2.0...
Installing to ~/.qntx/plugins/qntx-code-plugin
Added to am.toml: plugin.enabled = ["code"]

$ qntx plugin list
code     v0.2.0  [enabled]   Software development domain
finance  v0.1.0  [available] Financial analysis domain
biotech  -       [available] Bioinformatics domain
</code></pre>
<h2>Alternatives Considered</h2>
<h3>Individual am.<domain>.toml Files</h3>
<p><strong>Rejected</strong>: File proliferation, unclear which plugins are enabled, harder to manage</p>
<h3>Plugin Registry Service</h3>
<p><strong>Rejected</strong>: Too complex for Phase 3, adds external dependency</p>
<h3>Automatic Plugin Discovery (No Whitelist)</h3>
<p><strong>Rejected</strong>: Security risk (auto-loading unknown binaries), against minimal core principle</p>
<h3>Go Plugin (.so files)</h3>
<p><strong>Rejected</strong>: Platform-specific, fragile across Go versions, build complexity</p>
<h2>Related</h2>
<ul>
<li><a href="./ADR-001-domain-plugin-architecture.html">ADR-001: Domain Plugin Architecture</a></li>
<li><a href="./ADR-003-plugin-communication.html">ADR-003: Plugin Communication Patterns</a></li>
<li>PR #136: Phase 3 - Plugin Discovery and Optional Loading</li>
<li>Issue #135: Phase 4 - Extract qntx-code to Separate Repository</li>
</ul>
<footer class="site-footer">
  <p class="provenance">Generated by sitegen.nix at commit <a href="https://github.com/teranos/QNTX/commit/b664e41fac56a47a886ef727bc4342996b929f1d-dirty">b664e41-dirty</a></p>
</footer>
</body>
</html>
