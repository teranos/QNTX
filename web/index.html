<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>qntx graph</title>
    <link rel="icon" type="image/jpeg" href="/qntx.jpg">
    <!-- Core styles -->
    <link rel="stylesheet" href="/css/core.css">

    <!-- Component styles -->
    <link rel="stylesheet" href="/css/components.css">

    <!-- Graph and visualization -->
    <link rel="stylesheet" href="/css/graph.css">

    <!-- Panel base styles -->
    <link rel="stylesheet" href="/css/panel-base.css">

    <!-- Feature panels -->
    <link rel="stylesheet" href="/css/ai-provider-panel.css">
    <link rel="stylesheet" href="/css/command-explorer-panel.css">
    <link rel="stylesheet" href="/css/go-editor-panel.css">
    <link rel="stylesheet" href="/css/job-detail-panel.css">
    <link rel="stylesheet" href="/css/job-list-panel.css">
    <link rel="stylesheet" href="/css/plugin-panel.css">
    <link rel="stylesheet" href="/css/prose-panel.css">
    <link rel="stylesheet" href="/css/pulse-panel.css">
    <link rel="stylesheet" href="/css/pulse-scheduling.css">
    <link rel="stylesheet" href="/css/webscraper-panel.css">

    <!-- Code editor components -->
    <link rel="stylesheet" href="/css/ats-code-block.css">
    <link rel="stylesheet" href="/css/ats-language-client.css">
    <link rel="stylesheet" href="/css/code-block-base.css">
    <link rel="stylesheet" href="/css/code-suggestions.css">
    <link rel="stylesheet" href="/css/codemirror.css">
    <link rel="stylesheet" href="/css/go-code-block.css">

    <!-- UI components -->
    <link rel="stylesheet" href="/css/config-panel.css">
    <link rel="stylesheet" href="/css/feedback.css">
    <link rel="stylesheet" href="/css/filetree.css">
    <link rel="stylesheet" href="/css/left-panel.css">
    <link rel="stylesheet" href="/css/loading.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/symbol-palette.css">
    <link rel="stylesheet" href="/css/toast.css">
    <link rel="stylesheet" href="/css/usage-badge.css">
    <link rel="stylesheet" href="/css/utilities.css">
    <link rel="stylesheet" href="/css/window.css">
    <link rel="stylesheet" href="/css/ctp2.css">
</head>
<body class="disconnected">
    <!-- Loading screen - shows immediately before any scripts run -->
    <!-- Styles defined in /css/loading.css -->
    <div id="loading-screen">
        <img class="logo" src="/qntx.jpg" alt="qntx">
        <div class="status-text">Loading</div>
        <div class="progress-bar-container">
            <div id="loading-bar"></div>
        </div>
        <div id="loading-status">Initializing...</div>
        <div id="loader-logs">
            <div style="color: #888;">Starting initialization...</div>
        </div>
        <div id="metamask-warning">
            <div class="warning-title">‚ö†Ô∏è MetaMask detected</div>
            <div class="warning-text">
                MetaMask's security features can slow page loading by 30+ seconds.
                <br>
                For best performance, use a browser profile without MetaMask.
            </div>
        </div>
    </div>

    <!-- Inline loading progress script - runs immediately, not blocked by extensions -->
    <script>
    (function() {
        const bar = document.getElementById('loading-bar');
        const status = document.getElementById('loading-status');
        const warning = document.getElementById('metamask-warning');
        const logPanel = document.getElementById('loader-logs');
        let progress = 0;
        let startTime = Date.now();
        let metaMaskDetected = false;
        let logEntries = [];
        const MAX_LOG_ENTRIES = 10;

        // TIMING: Log when inline script starts
        const navStart = performance.timeOrigin || (performance.timing && performance.timing.navigationStart) || Date.now();
        console.log('[TIMING] Inline script start:', Date.now() - navStart, 'ms');

        /**
         * Log a step in the initialization process
         * @param {string} message - The message to log
         * @param {boolean} isError - Whether this is an error (dark red) or success (gray)
         * @param {boolean} isInProgress - Whether this is an in-progress step (medium gray)
         */
        window.logLoaderStep = function(message, isError = false, isInProgress = false) {
            const timestamp = new Date().toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            let icon = '‚úì';
            let color = '#999'; // light gray

            if (isError) {
                icon = '‚úó';
                color = '#cc4444'; // dark red for errors
            } else if (isInProgress) {
                icon = '‚Üí';
                color = '#888'; // medium gray for in-progress
            }

            const entry = {
                timestamp,
                icon,
                message,
                color
            };

            logEntries.push(entry);

            // Keep only last MAX_LOG_ENTRIES
            if (logEntries.length > MAX_LOG_ENTRIES) {
                logEntries.shift();
            }

            // Rebuild log panel HTML
            let html = '';
            logEntries.forEach(e => {
                html += `<div style="color: ${e.color}; margin-bottom: 2px; word-break: break-word;"><span style="opacity: 0.6;">[${e.timestamp}]</span> ${e.icon} ${e.message}</div>`;
            });
            logPanel.innerHTML = html;

            // Auto-scroll to bottom
            logPanel.scrollTop = logPanel.scrollHeight;

            // Also log to browser console
            console.log(`[LOADER] ${icon} ${message}`);
        };

        // Initial log entry
        window.logLoaderStep('Starting initialization...');

        // Check for MetaMask after a short delay (give it time to inject)
        setTimeout(() => {
            if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                metaMaskDetected = true;
                window.logLoaderStep('MetaMask detected', false, true);
            }
        }, 100);

        // Capture JavaScript errors and module loading errors
        window.addEventListener('error', (event) => {
            if (event.error) {
                const message = event.message || event.error.toString();
                window.logLoaderStep(`Error: ${message}`, true);
            }
        });

        // Capture module loading errors (import/require failures)
        window.addEventListener('unhandledrejection', (event) => {
            if (event.reason) {
                const message = event.reason.message || event.reason.toString();
                window.logLoaderStep(`Module error: ${message}`, true);
            }
        });

        // Simulate loading progress while waiting for scripts
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90; // Stop at 90% until real init
            bar.style.width = progress + '%';

            const elapsed = (Date.now() - startTime) / 1000;

            if (progress > 30 && !status.textContent.includes('Loading scripts')) {
                status.textContent = 'Loading scripts...';
                if (logEntries.length === 1) {
                    window.logLoaderStep('Loading scripts...');
                }
            }
            if (progress > 60 && !status.textContent.includes('Waiting for initialization')) {
                status.textContent = 'Waiting for initialization...';
                if (!logEntries.some(e => e.message.includes('Parsing'))) {
                    window.logLoaderStep('Parsing modules...', false, true);
                }
            }

            // Show MetaMask warning after 5 seconds if detected
            if (elapsed > 5 && metaMaskDetected && warning.style.display === 'none') {
                warning.style.display = 'block';
                status.textContent = 'Waiting for MetaMask security checks...';
                window.logLoaderStep('MetaMask security checks...', false, true);
            }
        }, 300);

        // Remove loading screen when app is ready
        window.hideLoadingScreen = function() {
            clearInterval(interval);
            bar.style.width = '100%';
            status.textContent = 'Ready!';
            window.logLoaderStep('Application ready');

            // Fade out after a brief delay to show "Ready!" message
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.classList.add('fade-out');

                // Actually hide after fade completes
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }, 300);
        };

        // TIMING: Log key events
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[TIMING] DOMContentLoaded fired:', Date.now() - performance.timing.navigationStart, 'ms');
            window.logLoaderStep('DOM content loaded');
        });

        window.addEventListener('load', () => {
            console.log('[TIMING] window.load fired:', Date.now() - performance.timing.navigationStart, 'ms');
            window.logLoaderStep('Window load event fired');
        });
    })();
    </script>

    <main id="container">
        <div id="left-panel">
            <!-- Virtue #4: Semantic HTML - Use <header> for page header -->
            <header id="header">
                <div class="header-logo">
                    <img src="/qntx.jpg" alt="QNTX">
                </div>
                <div class="header-build-info">
                    <span id="build-hash"></span>
                </div>
            </header>

            <div id="query-container">
                <!-- Symbol Palette - SEG Symbol Interface -->
                <!-- Virtue #4: Semantic HTML - Use <nav> for symbol palette navigation -->
                <div id="symbolPalette" class="symbol-palette" role="toolbar" aria-label="Symbol palette">
                    <button type="button" class="palette-cell" data-cmd="i" data-label="i ‚Äî self" aria-label="Self: operator vantage point">‚çü</button>
                    <button type="button" class="palette-cell" data-cmd="am" data-label="am ‚Äî structure" aria-label="Structure: system configuration">‚â°</button>
                    <button type="button" class="palette-cell" data-cmd="ix" data-label="ix ‚Äî ingest" aria-label="Ingest: import external data">‚®≥</button>
                    <button type="button" class="palette-cell" data-cmd="vidstream" data-label="vidstream ‚Äî video inference" aria-label="VidStream: real-time video inference">‚ÆÄ</button>
                    <button type="button" class="palette-cell" data-cmd="ax" data-label="ax ‚Äî expand" aria-label="Expand: surface related context">‚ãà</button>
                    <button type="button" class="palette-cell" data-cmd="as" data-label="as ‚Äî assert" aria-label="Assert: emit attestation">+</button>
                    <button type="button" class="palette-cell" data-cmd="is" data-label="is ‚Äî identity" aria-label="Identity: equivalence check">==</button>
                    <button type="button" class="palette-cell" data-cmd="of" data-label="of ‚Äî membership" aria-label="Membership: element-of relation">‚àà</button>
                    <button type="button" class="palette-cell" data-cmd="by" data-label="by ‚Äî actor" aria-label="Actor: origin of action">‚å¨</button>
                    <button type="button" class="palette-cell" data-cmd="at" data-label="at ‚Äî event" aria-label="Event: temporal marker">‚ú¶</button>
                    <button type="button" class="palette-cell" data-cmd="so" data-label="so ‚Äî therefore" aria-label="Therefore: consequent action">‚ü∂</button>
                    <button type="button" class="palette-cell" data-cmd="pulse" data-label="pulse ‚Äî scheduled jobs" aria-label="Pulse: scheduled jobs dashboard">Í©ú</button>
                    <button type="button" class="palette-cell" data-cmd="db" data-label="db ‚Äî database" aria-label="Database: statistics and storage">‚äî</button>
                    <button type="button" class="palette-cell" data-cmd="prose" data-label="prose ‚Äî documentation" aria-label="Prose: documentation editor">‚ñ£</button>
                    <button type="button" class="palette-cell" data-cmd="go" data-label="go ‚Äî code editor" aria-label="Go: code editor with LSP">go</button>
                    <button type="button" class="palette-cell" data-cmd="py" data-label="py ‚Äî python" aria-label="Python: code execution">py</button>
                    <button type="button" class="palette-cell" data-cmd="plugins" data-label="plugins ‚Äî domain plugins" aria-label="Plugins: installed domain plugins">&#9881;</button>
                    <button type="button" class="palette-cell" data-cmd="scraper" data-label="scraper ‚Äî content extraction" aria-label="Scraper: content extraction">‚õ∂</button>
                    <button type="button" class="palette-cell" data-cmd="ctp2" data-label="ctp2" aria-label="CTP2" id="ctp2-palette-cell">
                        <!-- SVG glyph will be injected here by TypeScript -->
                    </button>
                </div>

                <div id="query-drop-zone">
                    <!-- CodeMirror 6 Editor Container -->
                    <div id="codemirror-container"></div>

                    <div id="drop-indicator">
                        <div class="drop-icon">üìÑ</div>
                        <div class="drop-text">Drop to create ix command</div>
                    </div>
                </div>
                <button id="run-ix-button">
                    <span class="button-icon">‚ñ∂</span>
                    <span class="button-text">Run</span>
                </button>
            </div>
            <div id="stats">
                <div class="stat-item">Nodes: <span class="stat-value" id="node-count">0</span></div>
                <div class="stat-item">Links: <span class="stat-value" id="link-count">0</span></div>
                <div class="stat-item">
                    Limit:
                    <select id="graph-limit" class="stat-value">
                        <option value="100">100</option>
                        <option value="500">500</option>
                        <option value="1000" selected>1000</option>
                        <option value="5000">5000</option>
                        <option value="10000">10k</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- TODO: Rename #graph-container to #graph-viewer for clarity
             Current name is ambiguous - "container" doesn't convey it's the graph viewing area.
             "graph-viewer" better describes its purpose as the interactive graph visualization space. -->
        <div id="graph-container">
            <!-- TODO: Rename #controls to #legenda-container or #graph-controls
                 Current name is too generic - doesn't indicate it contains the legenda.
                 "legenda-container" would be clearer and match its actual content. -->
            <aside id="controls" role="toolbar" aria-label="Graph controls">
                <!-- Legenda and isolated toggle built dynamically by legenda.js -->
                <div class="legenda"></div>
            </aside>
            <!-- TODO: Remove #attestation-feed - deprecated, no longer used -->
            <div id="attestation-feed"></div>
            <svg id="graph"></svg>
            <div class="graph-data-tooltip" id="tooltip" role="tooltip"></div>
        </div>
    </main>

    <!-- Toast Notifications -->
    <div id="toast-container" role="status" aria-live="polite"></div>

    <!-- Pulse Configuration Panel (Daily + Monthly Budget) -->
    <div id="pulse-config-overlay" class="pulse-config-overlay" style="display: none;">
        <div id="pulse-config-panel" class="pulse-config-panel">
            <div class="pulse-config-header">
                <h2>Pulse Budget</h2>
                <button id="pulse-config-close" class="panel-close">√ó</button>
            </div>
            <div class="pulse-config-body">
                <form id="pulse-config-form">
                    <div class="config-field">
                        <label for="daily-budget">Daily Budget (USD)</label>
                        <input type="number" id="daily-budget" step="0.01" min="0" required>
                    </div>
                    <div class="config-field">
                        <label for="weekly-budget">Weekly Budget (USD)</label>
                        <input type="number" id="weekly-budget" step="0.01" min="0" required>
                    </div>
                    <div class="config-field">
                        <label for="monthly-budget">Monthly Budget (USD)</label>
                        <input type="number" id="monthly-budget" step="0.01" min="0" required>
                    </div>
                    <div class="config-actions">
                        <button type="submit">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Combined Log Panel (Server + ix Progress side by side) -->
    <div id="system-drawer">
        <div id="system-drawer-header">
            <!-- Usage badge and status indicators will be inserted here dynamically by TypeScript -->
            <div class="controls">
                <span id="system-version"></span>
                <select id="verbosity-select">
                    <option value="0">User</option>
                    <option value="1">Info (-v)</option>
                    <option value="2" selected>Debug (-vv)</option>
                    <option value="3">Trace (-vvv)</option>
                    <option value="4">All (-vvvv)</option>
                </select>
                <button id="download-logs" title="Download log file (verbosity >= 2)">Download</button>
                <button id="clear-logs">Clear All</button>
                <button id="toggle-logs">‚ñ≤</button>
            </div>
        </div>
        <div id="log-panels-container">
            <div class="log-column">
                <div class="log-column-header">
                    Server <span id="log-count" class="count">(0)</span>
                </div>
                <div id="log-content" class="log-column-content"></div>
            </div>
        </div>
    </div>

    <!-- Load D3.js locally (bundled) - Virtue #2: Minimize external dependencies -->

    <!-- async instead of defer: Don't block DOMContentLoaded, load independently -->
    <script async src="/js/vendor/d3.v7.min.js" onload="console.log('[TIMING] D3.js loaded:', Date.now() - (performance.timeOrigin || Date.now()), 'ms')"></script>

    <!-- Load app after DOM is ready (type="module" defers automatically) -->
    <script type="module" src="/ts/main.ts"></script>

    <!-- TIMING: Track module script execution -->
    <script>
    console.log('[TIMING] HTML parsing complete:', Date.now() - (performance.timeOrigin || Date.now()), 'ms');
    </script>

    <!-- Graph limit control -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const limitSelect = document.getElementById('graph-limit');
        if (limitSelect) {
            limitSelect.addEventListener('change', (e) => {
                const limit = parseInt(e.target.value, 10);
                if (window.ws && window.ws.readyState === WebSocket.OPEN) {
                    window.ws.send(JSON.stringify({
                        type: 'set_graph_limit',
                        graph_limit: limit
                    }));
                    console.log(`[GRAPH LIMIT] Changed to ${limit}`);
                }
            });
        }
    });
    </script>
</body>
</html>
