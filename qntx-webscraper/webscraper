#!/bin/bash
# QNTX WebScraper Plugin Launcher
# Place this file in ~/.qntx/plugins/webscraper (make it executable)

# Enable error logging
set -e

# Log to stderr for debugging
exec 2>&1

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Find the qntx-webscraper directory
# Override with QNTX_WEBSCRAPER_DIR env var if needed
PLUGIN_DIR="${QNTX_WEBSCRAPER_DIR:-$SCRIPT_DIR}"

echo "Starting webscraper plugin..." >&2
echo "Plugin directory: $PLUGIN_DIR" >&2

# Check if the plugin directory exists
if [ ! -d "$PLUGIN_DIR" ]; then
    echo "Error: Plugin directory not found at $PLUGIN_DIR" >&2
    echo "Set QNTX_WEBSCRAPER_DIR environment variable to the correct path" >&2
    exit 1
fi

# Activate virtual environment
if [ -f "$PLUGIN_DIR/.venv/bin/activate" ]; then
    source "$PLUGIN_DIR/.venv/bin/activate"
else
    echo "Error: Virtual environment not found at $PLUGIN_DIR/.venv" >&2
    echo "Run: cd $PLUGIN_DIR && python3 -m venv .venv && source .venv/bin/activate && pip install -e ." >&2
    exit 1
fi

# Parse port from arguments
PORT=50052
for arg in "$@"; do
    case $arg in
        --port=*)
            PORT="${arg#*=}"
            ;;
        --port)
            shift
            PORT="$1"
            ;;
    esac
    shift
done

# Run the Python plugin
cd "$PLUGIN_DIR"
echo "Running: python run_plugin.py --port $PORT" >&2
exec python run_plugin.py --port "$PORT"